function GameData(){this.score=0,this.level={current:0,toGo:0},this.comboCount=0,this.combo=[],this.bonus={multipolar:{count:1,isActive:!1},undo:{count:3},bomb:{count:1,isActive:!1}},this.gameMap,this.turn={turnCount:0,turnCurrentLevel:0},this.turnValue=[0,0,0,0],this.scores}function Game(){function n(){s(),localStorage.setItem(o(c.sKey+"."+c.sKey),o(JSON.stringify(S)))}function o(n){var o=100,t="",o=c.match;for(i=0;i<n.length;i++)t+=String.fromCharCode(o^n.charCodeAt(i));return t}function t(n,o,t){return n*o/t+(n-t*o)}function r(n,o,t){return n+o+t}function e(n,o,t){return n*o+t}function u(n,o,r){return e(o,n,n)+t(r,o,o)}function a(){for(i=0;i<c.bS;i++)for(j=0;j<c.bS;j++)if(0==S.gameMap[i][j])return!1;return!0}function s(){var n=S.score,o=S.level.currentLevel,i=S.comboCount,a=S.bonus.multipolar,c=S.level.toGo,s=S.turn.turnCount;S.scores=t(n,o,i)+r(o,i,c)+e(i,a,c)-u(a,c,s)}function m(){var n=S.score,o=S.level.currentLevel,i=S.comboCount,a=S.bonus.multipolar,c=S.level.toGo,s=S.turn.turnCount;return S.scores==t(n,o,i)+r(o,i,c)+e(i,a,c)-u(a,c,s)?!0:!1}function l(){var n=S.level.current,o=S.level.toGo,t=5*n+5,r=S.turn.turnCount,e=S.turn.turnCurrentLevel;0==n&&(n=1,o=10,r=0,e=0),remain=t-o,remain==t?(n+=1,o=5*n+5,S.bonus.undo.count++,e=0):(o-=1,e++),r++,S.level.current=n,S.level.toGo=o,S.turn.turnCount=r,S.turn.turnCurrentLevel=e}function b(n){return n%2==0?!0:!1}function v(n,o,t,r,e){var u=new Array(c.bS);for(i=0;i<c.bS;i++)for(u[i]=new Array(c.bS),a=0;a<c.bS;a++)u[i][a]={score:void 0,newV:void 0,oldV:void 0};if("bomb"==o)for(var i=-1;2>i;i++)for(var a=-1;2>a;a++){var s,m,l=t+i,b=r+a;if(C(l,b)&&(s=n[t][r],m=n[l][b],g(m,i,a,o))){var v=0,f=m;u[l][b]={score:f,newV:v,oldV:m},e||(n[l][b]=v)}}else if("mul"==o)for(var i=-1;2>i;i++)for(var a=-1;2>a;a++){var s,m,l=t+i,b=r+a;if(C(l,b)&&(s=n[t][r],m=n[l][b],g(m,i,a))){var v=m-s;v=0>v?0:v;var f=m-v;u[l][b]={score:f,newV:v,oldV:m},e||(n[l][b]=v)}}else for(var i=-1;2>i;i++)for(var a=-1;2>a;a++){var s,m,l=t+i,b=r+a;if(C(l,b)&&(s=n[t][r],m=n[l][b],g(m,i,a))){var v=0,f=0;p(m,s)?(v=m-s,v=0>v?0:v,f=m-v):(v=m+s,f=0),u[l][b]={score:f,newV:v,oldV:m},e||(n[l][b]=v)}}return u}function f(n){for(var o=0;o<n.length;o++)for(var t=0;t<n[o].length;t++)if(0==n[o][t].newV)return!0}function h(n,o){for(var t=0,r=0,e=0;e<n.length;e++)for(var u=0;u<n[e].length;u++)void 0!=n[e][u].score&&(t+=n[e][u].score,r+=1);return r>=c.mulMin&&S.bonus.multipolar.count++,0!=o?t*o:t}function p(n,o){return b(n)==b(o)?!0:!1}function g(n,o,t,r){return 0==n||0==o&&0==t&&"bomb"!=r?!1:!0}function C(n,o){return n>c.bS-1||0>n||o>c.bS-1||0>o?!1:!0}function d(n,o){return Math.floor(Math.random()*(o-n))+n}var S,G=[];this.getGameData=function(){return S},this.getGameHistory=function(){return G},this.newGame=function(){for(S=new GameData,map=S.gameMap,map=new Array(c.bS),e=0;e<c.bS;e++)for(map[e]=new Array(c.bS),j=0;j<c.bS;j++)map[e][j]=0;for(var n=0,o=0;n!=c.initCount;){var t=d(0,9),r=d(0,9);0==map[t][r]&&(map[t][r]=d(1,11),n++),o++}console.log(o);for(var e=0;4>e;e++)S.turnValue[e]=d(1,11);S.gameMap=map},this.continueGame=function(){var n=localStorage.getItem(o(c.sKey+"."+c.sKey));void 0!=n?(S=JSON.parse(o(n)),m()||this.newGame()):this.newGame()},this.turn=function(o,t){var r={error:[],state:"",score:0,isGameOver:!1},e=S.gameMap;if(o=parseInt(o),t=parseInt(t),!C(o,t))return r.error.push(1),r;if(0!=e[o][t])return r.error.push(1),r;G.length>4&&G.pop(),G.unshift(S),multipolar=S.bonus.multipolar.isActive,bomb=S.bonus.bomb.isActive,e[o][t]=S.turnValue[0],console.log(e[o][t]),bomb?(r.state=v(e,"bomb",o,t),S.bonus.bomb.count--,S.bonus.bomb.isActive=!1):multipolar?(r.state=v(e,"mul",o,t),S.bonus.multipolar.count--,S.bonus.multipolar.isActive=!1):r.state=v(e,"nor",o,t),r.score=h(r.state,S.comboCount),S.score=S.score+r.score;var u=S.comboCount;f(r.state)?(S.comboCount=u+1,S.comboCount>=c.bombMin&&S.bonus.bomb.count++):0!=S.comboCount&&(S.combo.push(S.comboCount),S.comboCount=0),l();var i=S.level.current;return S.turnValue.shift(),S.turnValue.push(d(2*i-1,5*i+5)),n(),r.isGameOver=a(),r},this.isBoxEmpty=function(n,o){return 0!=S.gameMap[n][o]?!1:!0},this.turnPreview=function(n,o){var t=S.bonus.multipolar.isActive,r=S.bonus.bomb.isActive;return r?v(gameMap,"bomb",n,o,!0):t?v(gameMap,"mul",n,o,!0):v(gameMap,"nor",n,o,!0)},this.undo=function(){this.isCanUndo()&&(S=G.shift(),S.bonus.undo.count--)},this.isCanUndo=function(){return void 0==G?!1:G.length>0&&S.bonus.undo.count>0?!0:!1},this.bonus=function(n){var o=S.bonus;if("multipolar"!=n&&"bomb"!=n)return!1;var t=o[n].isActive,r=o[n].count;return t=1>r?!1:t?!1:!0,o[n].isActive=t,t}}var c={bS:9,bombMin:4,mulMin:5,sKey:"nananabatman",match:5,initCount:20};