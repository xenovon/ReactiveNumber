function GameData(){this.score=0,this.level={current:0,toGo:0,totalThisLevel:0},this.comboCount=0,this.combo=[],this.bonus={multipolar:{count:1,isActive:!1},undo:{count:c.undoStart},bomb:{count:1,isActive:!1}},this.gameMap=[],this.turn={turnCount:0,turnCurrentLevel:0},this.turnValue=[0,0,0,0],this.scores=0}function Game(){function t(t){var n=0,o=0,r=G.level.current;r=0==r?r+1:r;for(var e=G.gameMap;n!=t;){var u=A[M(0,A.length)];if(void 0==u)break;var i=parseInt(u.split(".")[0]),a=parseInt(u.split(".")[1]);if(0==e[i][a]&&(e[i][a]=M(2*r-1,5*r+5),y(i,a),n++),o++,o>1e3)break}}function n(){l(),localStorage.setItem(V,o(JSON.stringify(G))),localStorage.setItem(I,o(JSON.stringify(w)))}function o(t){var n=100,o="",n=c.match;for(i=0;i<t.length;i++)o+=String.fromCharCode(n^t.charCodeAt(i));return o}function r(){return 0!=A.length?!1:(localStorage.removeItem(I),localStorage.removeItem(V),w=[],!0)}function e(t,n,o){return t*n*o+(t-o*n)}function u(t,n,o){return t+n+o}function a(t,n,o){return t*n+o}function s(t,n,o){return a(n,t,t)+e(o,n,n)}function l(){var t=G.score,n=G.level.current,o=G.comboCount,r=G.bonus.multipolar.count,i=G.level.toGo,c=G.turn.turnCount;G.scores=e(t,n,o)+u(n,o,i)+a(o,r,i)-s(r,i,c)}function v(){var t=G.score,n=G.level.current,o=G.comboCount,r=G.bonus.multipolar.count,i=G.level.toGo,c=G.turn.turnCount;return G.scores==e(t,n,o)+u(n,o,i)+a(o,r,i)-s(r,i,c)?!0:!1}function m(t){return 5*t+5}function b(){var t=G.level.current,n=G.level.toGo,o=m(t),r=G.turn.turnCount,e=G.turn.turnCurrentLevel,u=G.level.totalThisLevel;0==t&&(t=1,n=m(t),r=0,e=0,u=10),remain=o-n,remain==o?(t+=1,n=m(t),G.bonus.undo.count++,e=0,u=n):(n--,e++),r++,G.level.current=t,G.level.toGo=n,G.turn.turnCount=r,G.turn.turnCurrentLevel=e,G.level.totalThisLevel=u}function f(t){return t%2==0?!0:!1}function h(t,n,o,r,e){var u=new Array(c.bS);for(i=0;i<c.bS;i++)for(u[i]=new Array(c.bS),a=0;a<c.bS;a++)u[i][a]={score:void 0,newV:void 0,oldV:void 0};if("bomb"==n)for(var i=-1;2>i;i++)for(var a=-1;2>a;a++){var s,l,v=o+i,m=r+a;if(d(v,m)&&(s=t[o][r],l=t[v][m],C(l,i,a,n))){var b=0,f=l;u[v][m]={score:f,newV:b,oldV:l},e||(t[v][m]=b,y(v,m))}}else if("mul"==n)for(var i=-1;2>i;i++)for(var a=-1;2>a;a++){var s,l,v=o+i,m=r+a;if(d(v,m)&&(s=t[o][r],l=t[v][m],C(l,i,a,n))){var b=l-s;b=0>b?0:b;var f=l-b;u[v][m]={score:f,newV:b,oldV:l},e||(t[v][m]=b,y(v,m))}}else for(var i=-1;2>i;i++)for(var a=-1;2>a;a++){var s,l,v=o+i,m=r+a;if(d(v,m)&&(s=t[o][r],l=t[v][m],C(l,i,a,n))){var b=0,f=0;S(l,s)?(b=l-s,b=0>b?0:b,f=l-b):(b=l+s,f=0),u[v][m]={score:f,newV:b,oldV:l},e||(t[v][m]=b,y(v,m))}}return u}function p(t){for(var n=0;n<t.length;n++)for(var o=0;o<t[n].length;o++)if(0==t[n][o].newV)return!0}function g(t){for(var n=0,o=0,r=0;r<t.length;r++)for(var e=0;e<t[r].length;e++)void 0!=t[r][e].score&&(n+=t[r][e].score,0==t[r][e].newV&&(o+=1));return o>=c.bombMin&&G.bonus.bomb.count++,n*G.level.current}function S(t,n){return f(t)==f(n)?!0:!1}function C(t,n,o,r){return 0==t||0==n&&0==o&&"bomb"!=r?!1:!0}function d(t,n){return t>c.bS-1||0>t||n>c.bS-1||0>n?!1:!0}function M(t,n){return Math.floor(Math.random()*(n-t))+t}function y(t,n){var o=t+"."+n;if(0==G.gameMap[t][n])A.push(o);else for(var r=A.length-1;r>=0;r--)if(A[r]===o){A.splice(r,1);break}}var G,w=[],A=[],V=o(c.sKey+""+c.sKey),I=o(c.sKey+""+c.sKey+c.sKey);this.getGameData=function(){return G},this.getGameHistory=function(){return w},this.getEmptyBlockMap=function(){return A},this.newGame=function(){G=new GameData,w=[],A=[];var n=G.gameMap;for(n=new Array(c.bS),o=0;o<c.bS;o++)for(n[o]=new Array(c.bS),j=0;j<c.bS;j++)n[o][j]=0;for(var o=0;4>o;o++)G.turnValue[o]=M(1,11);for(G.gameMap=n,o=0;o<c.bS;o++)for(j=0;j<c.bS;j++)y(o,j);t(c.initCount)},this.isHasContinue=function(){return void 0!=localStorage.getItem(V)?!0:!1},this.continueGame=function(){var t=localStorage.getItem(V),n=localStorage.getItem(I);void 0!=t&&void 0!=n?(G=JSON.parse(o(t)),v()?w=JSON.parse(o(n)):this.newGame()):this.newGame()},this.turn=function(o,e){var u={error:[],state:"",score:0,isGameOver:!1},i=G.gameMap;if(o=parseInt(o),e=parseInt(e),!d(o,e))return u.error.push(1),u;if(0!=i[o][e])return u.error.push(1),u;w.length>4&&w.pop(),w.unshift(JSON.stringify(G)),multipolar=G.bonus.multipolar.isActive,bomb=G.bonus.bomb.isActive,i[o][e]=G.turnValue[0],y(o,e),bomb?(u.state=h(i,"bomb",o,e),G.bonus.bomb.count--,G.bonus.bomb.isActive=!1):multipolar?(u.state=h(i,"mul",o,e),G.bonus.multipolar.count--,G.bonus.multipolar.isActive=!1):u.state=h(i,"nor",o,e),u.score=g(u.state,G.comboCount),G.score=G.score+u.score;var a=G.comboCount;p(u.state)?(G.comboCount=a+1,G.comboCount==c.mulMin&&G.bonus.multipolar.count++):0!=G.comboCount&&(G.combo.push(G.comboCount),G.comboCount=0),b();var s=G.level.current;return G.turnValue.shift(),G.turnValue.push(M(2*s-1,5*s+5)),t(c.popCount),n(),u.isGameOver=r(),u},this.isBoxEmpty=function(t,n){return 0!=G.gameMap[t][n]?!1:!0},this.turnPreview=function(t,n){var o=G.bonus.multipolar.isActive,r=G.bonus.bomb.isActive;return r?h(gameMap,"bomb",t,n,!0):o?h(gameMap,"mul",t,n,!0):h(gameMap,"nor",t,n,!0)},this.undo=function(){if(this.isCanUndo()){var t=G.bonus.undo.count;G=JSON.parse(w.shift()),t--,G.bonus.undo.count=t}},this.isCanUndo=function(){return void 0==w?!1:w.length>0&&G.bonus.undo.count>0?!0:!1},this.bonus=function(t){var n=G.bonus;if("multipolar"!=t&&"bomb"!=t)return!1;var o=n[t].isActive,r=n[t].count;return o=1>r?!1:o?!1:!0,n[t].isActive=o,o}}var c={bS:9,bombMin:4,mulMin:6,sKey:"nananabatman",match:5,popCount:1,undoStart:2,initCount:15};