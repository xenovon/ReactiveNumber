function GameData(){this.score=0,this.level={current:0,toGo:0,totalThisLevel:0},this.comboCount=0,this.combo=[],this.bonus={multipolar:{count:1,isActive:!1},undo:{count:c.undoStart},bomb:{count:1,isActive:!1}},this.gameMap=[],this.turn={turnCount:0,turnCurrentLevel:0},this.turnValue=[0,0,0,0],this.scores=0}function Game(){function t(t){var o=0,n=0,r=y.level.current;r=0==r?r+1:r;for(var e=y.gameMap;o!=t;){var u=V[G(0,V.length)];if(void 0==u)break;var i=parseInt(u.split(".")[0]),a=parseInt(u.split(".")[1]);if(e[i][a]=G(2*r-1,5*r+5),M(i,a),o++,n++,n>1e3)break}}function o(){console.time("turn"),v(),localStorage.setItem(I,n(JSON.stringify(y))),localStorage.setItem(O,n(JSON.stringify(w))),console.timeEnd("turn")}function n(t){var o=100,n="",o=c.match;for(i=0;i<t.length;i++)n+=String.fromCharCode(o^t.charCodeAt(i));return n}function r(){return 0!=V.length?!1:(y.bonus.undo.count=0,e(),!0)}function e(){localStorage.removeItem(O),localStorage.removeItem(I),w=[],V=[]}function u(t,o,n){return t*o*n+(t-n*o)}function a(t,o,n){return t+o+n}function s(t,o,n){return t*o+n}function l(t,o,n){return s(o,t,t)+u(n,o,o)}function v(){var t=y.score,o=y.level.current,n=y.comboCount,r=y.bonus.multipolar.count,e=y.level.toGo,i=y.turn.turnCount;y.scores=u(t,o,n)+a(o,n,e)+s(n,r,e)-l(r,e,i)}function m(){var t=y.score,o=y.level.current,n=y.comboCount,r=y.bonus.multipolar.count,e=y.level.toGo,i=y.turn.turnCount;return y.scores==u(t,o,n)+a(o,n,e)+s(n,r,e)-l(r,e,i)?!0:!1}function b(t){return 5*t+5}function f(){var t=y.level.current,o=y.level.toGo,n=b(t),r=y.turn.turnCount,e=y.turn.turnCurrentLevel,u=y.level.totalThisLevel;0==t&&(t=1,o=b(t),r=0,e=1,u=10),remain=n-o,remain==n-1?(t+=1,o=b(t),y.bonus.undo.count++,e=1,u=o):(o--,e++),r++,y.level.current=t,y.level.toGo=o,y.turn.turnCount=r,y.turn.turnCurrentLevel=e,y.level.totalThisLevel=u}function h(t){return t%2==0?!0:!1}function p(t,o,n,r,e){var u=new Array(c.bS);for(i=0;i<c.bS;i++)for(u[i]=new Array(c.bS),a=0;a<c.bS;a++)u[i][a]={score:void 0,newV:void 0,oldV:void 0};if("bomb"==o)for(var i=-1;2>i;i++)for(var a=-1;2>a;a++){var s,l,v=n+i,m=r+a;if(A(v,m)&&(s=t[n][r],l=t[v][m],d(l,i,a,o))){var b=0,f=l;u[v][m]={score:f,newV:b,oldV:l},e||(t[v][m]=b,M(v,m))}}else if("mul"==o)for(var i=-1;2>i;i++)for(var a=-1;2>a;a++){var s,l,v=n+i,m=r+a;if(A(v,m)&&(s=t[n][r],l=t[v][m],d(l,i,a,o))){var b=l-s;b=0>b?0:b;var f=l-b;u[v][m]={score:f,newV:b,oldV:l},e||(t[v][m]=b,M(v,m))}}else for(var i=-1;2>i;i++)for(var a=-1;2>a;a++){var s,l,v=n+i,m=r+a;if(A(v,m)&&(s=t[n][r],l=t[v][m],d(l,i,a,o))){var b=0,f=0;S(l,s)?(b=l-s,b=0>b?0:b,f=l-b):(b=l+s,f=0),u[v][m]={score:f,newV:b,oldV:l},e||(t[v][m]=b,M(v,m))}}return u}function g(t){for(var o=0;o<t.length;o++)for(var n=0;n<t[o].length;n++)if(0==t[o][n].newV)return!0}function C(t){for(var o=0,n=0,r=0;r<t.length;r++)for(var e=0;e<t[r].length;e++)void 0!=t[r][e].score&&(o+=t[r][e].score,0==t[r][e].newV&&(n+=1));return{scoreTotal:o*y.level.current,scoreCount:n}}function S(t,o){return h(t)==h(o)?!0:!1}function d(t,o,n,r){return 0==t||0==o&&0==n&&"bomb"!=r?!1:!0}function A(t,o){return t>c.bS-1||0>t||o>c.bS-1||0>o?!1:!0}function G(t,o){return Math.floor(Math.random()*(o-t))+t}function M(t,o){var n=t+"."+o;if(0==y.gameMap[t][o])V.push(n);else for(var r=V.length-1;r>=0;r--)if(V[r]===n){V.splice(r,1);break}}var y,w=[],V=[],I=n(c.sKey+""+c.sKey),O=n(c.sKey+""+c.sKey+c.sKey);this.getGameData=function(){return y},this.getGameHistory=function(){return w},this.getEmptyBlockMap=function(){return V},this.newGame=function(){w=[],V=[],y=new GameData;var o=y.gameMap;for(o=new Array(c.bS),n=0;n<c.bS;n++)for(o[n]=new Array(c.bS),j=0;j<c.bS;j++)o[n][j]=0;for(var n=0;4>n;n++)y.turnValue[n]=G(1,11);for(y.gameMap=o,n=0;n<c.bS;n++)for(j=0;j<c.bS;j++)M(n,j);t(c.initCount),y.level.toGo=10},this.isHasContinue=function(){return void 0!=localStorage.getItem(I)?!0:!1},this.continueGame=function(){var t=localStorage.getItem(I),o=localStorage.getItem(O);void 0!=t&&void 0!=o?(y=JSON.parse(n(t)),m()?w=JSON.parse(n(o)):this.newGame()):this.newGame()},this.turn=function(n,e){var u={error:[],state:"",score:0,isGameOver:!1},i=y.gameMap;if(n=parseInt(n),e=parseInt(e),!A(n,e))return u.error.push(1),u;if(0!=i[n][e])return u.error.push(1),u;w.length>50&&w.pop(),w.unshift(JSON.stringify(y)),multipolar=y.bonus.multipolar.isActive,bomb=y.bonus.bomb.isActive,i[n][e]=y.turnValue[0],M(n,e);var a=!1;bomb?(u.state=p(i,"bomb",n,e),a=y.bonus.bomb.isActive,y.bonus.bomb.count--,y.bonus.bomb.isActive=!1):multipolar?(u.state=p(i,"mul",n,e),a=y.bonus.multipolar.isActive,y.bonus.multipolar.count--,y.bonus.multipolar.isActive=!1):u.state=p(i,"nor",n,e);var s=C(u.state,y.comboCount);u.score=s.scoreTotal,y.score=y.score+u.score,s.scoreCount>=c.bombMin&&!a&&y.bonus.bomb.count++;var l=y.comboCount;g(u.state)?(y.comboCount=l+1,y.comboCount==c.mulMin&&y.bonus.multipolar.count++):0!=y.comboCount&&(y.combo.push(y.comboCount),y.comboCount=0),f();var v=y.level.current;return y.turnValue.shift(),y.turnValue.push(G(2*v-1,5*v+5)),t(c.popCount),o(),u.isGameOver=r(),u},this.isBoxEmpty=function(t,o){return 0!=y.gameMap[t][o]?!1:!0},this.turnPreview=function(t,o){var n=y.bonus.multipolar.isActive,r=y.bonus.bomb.isActive;return r?p(gameMap,"bomb",t,o,!0):n?p(gameMap,"mul",t,o,!0):p(gameMap,"nor",t,o,!0)},this.undo=function(){if(this.isCanUndo()){var t=y.bonus.undo.count;y=JSON.parse(w.shift()),t--,y.bonus.undo.count=t}},this.isCanUndo=function(){return void 0==w?!1:w.length>0&&y.bonus.undo.count>0?!0:!1},this.bonus=function(t){var o=y.bonus;if("multipolar"!=t&&"bomb"!=t)return!1;var n=o[t].isActive,r=o[t].count;return n=1>r?!1:n?!1:!0,o[t].isActive=n,n&&("multipolar"==t?o.bomb.isActive=!1:"","bomb"==t?o.multipolar.isActive=!1:""),n}}var c={bS:9,bombMin:4,mulMin:6,sKey:"nananabatman",match:5,popCount:1,undoStart:2,initCount:15};