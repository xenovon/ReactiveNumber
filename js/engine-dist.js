function GameData(){this.score=0,this.level={current:0,toGo:0,totalThisLevel:0},this.comboCount=0,this.combo=[],this.bonus={multipolar:{count:1,isActive:!1},undo:{count:c.undoStart},bomb:{count:1,isActive:!1}},this.emptyBlockMap=[],this.gameMap=[],this.turn={turnCount:0,turnCurrentLevel:0},this.turnValue=[0,0,0,0],this.scores=0}function Game(){function t(t){var o=0,r=0,e=w.level.current;e=0==e?e+1:e;for(var n=w.gameMap;o!=t;){var u=w.emptyBlockMap[M(0,w.emptyBlockMap.length-1)];if(void 0==u)break;var i=parseInt(u.split(".")[0]),a=parseInt(u.split(".")[1]);if(n[i][a]=M(A(),G()),y(i,a),o++,r++,r>1e3)break}}function o(){s(),localStorage.setItem(k,r(JSON.stringify(w))),localStorage.setItem(I,r(JSON.stringify(V)))}function r(t){var o="",r=c.match;for(i=0;i<t.length;i++)o+=String.fromCharCode(r^t.charCodeAt(i));return o}function e(){localStorage.removeItem(I),localStorage.removeItem(k),delete localStorage[k],delete localStorage[I],V=[]}function n(t,o,r){return t*o*r+(t-r*o)}function u(t,o,r){return t+o+r}function a(t,o,r){return t*o+r}function l(t,o,r){return a(o,t,t)+n(r,o,o)}function s(){var t=w.score,o=w.level.current,r=w.comboCount,e=w.bonus.multipolar.count,i=w.level.toGo,c=w.turn.turnCount;w.scores=n(t,o,r)+u(o,r,i)+a(r,e,i)-l(e,i,c)}function v(){var t=w.score,o=w.level.current,r=w.comboCount,e=w.bonus.multipolar.count,i=w.level.toGo,c=w.turn.turnCount;return w.scores==n(t,o,r)+u(o,r,i)+a(r,e,i)-l(e,i,c)?!0:!1}function m(t){return 5*t+5}function b(){var t=w.level.current,o=w.level.toGo,r=m(t),e=w.turn.turnCount,n=w.turn.turnCurrentLevel,u=w.level.totalThisLevel;0==t&&(t=1,o=m(t),e=0,n=1,u=10),remain=r-o,remain==r-1?(t+=1,o=m(t),w.bonus.undo.count++,n=1,u=o):(o--,n++),e++,w.level.current=t,w.level.toGo=o,w.turn.turnCount=e,w.turn.turnCurrentLevel=n,w.level.totalThisLevel=u}function f(t){return t%2==0?!0:!1}function p(t,o,r,e,n){var u=new Array(c.bS);for(i=0;i<c.bS;i++)for(u[i]=new Array(c.bS),a=0;a<c.bS;a++)u[i][a]={score:void 0,newV:void 0,oldV:void 0};if("bomb"==o)for(var i=-1;2>i;i++)for(var a=-1;2>a;a++){var l,s,v=r+i,m=e+a;if(C(v,m)&&(l=t[r][e],s=t[v][m],d(s,i,a,o))){var b=0,f=s;u[v][m]={score:f,newV:b,oldV:s},n||(t[v][m]=b,y(v,m))}}else if("mul"==o)for(var i=-1;2>i;i++)for(var a=-1;2>a;a++){var l,s,v=r+i,m=e+a;if(C(v,m)&&(l=t[r][e],s=t[v][m],d(s,i,a,o))){var b=s-l;b=0>b?0:b;var f=s-b;u[v][m]={score:f,newV:b,oldV:s},n||(t[v][m]=b,y(v,m))}}else for(var i=-1;2>i;i++)for(var a=-1;2>a;a++){var l,s,v=r+i,m=e+a;if(C(v,m)&&(l=t[r][e],s=t[v][m],d(s,i,a,o))){var b=0,f=0;S(s,l)?(b=s-l,b=0>b?0:b,f=s-b):(b=s+l,f=0),u[v][m]={score:f,newV:b,oldV:s},n||(t[v][m]=b,y(v,m))}}return u}function h(t){for(var o=0;o<t.length;o++)for(var r=0;r<t[o].length;r++)if(0==t[o][r].newV)return!0}function g(t){for(var o=0,r=0,e=0;e<t.length;e++)for(var n=0;n<t[e].length;n++)void 0!=t[e][n].score&&(o+=t[e][n].score,0==t[e][n].newV&&(r+=1));var u=0==w.level.current?1:w.level.current;return{scoreTotal:o*u,scoreCount:r}}function S(t,o){return f(t)==f(o)?!0:!1}function d(t,o,r,e){return 0==t||0==o&&0==r&&"bomb"!=e?!1:!0}function C(t,o){return t>c.bS-1||0>t||o>c.bS-1||0>o?!1:!0}function M(t,o){return Math.floor(Math.random()*(o-t))+t}function y(t,o){var r=w.emptyBlockMap,e=t+"."+o;if(0==w.gameMap[t][o])r.push(e);else for(var n=r.length-1;n>=0;n--)if(r[n]===e){r.splice(n,1);break}}function A(){var t;return t=w.level.current<1?1:w.level.current,2*t-1}function G(){var t;return t=w.level.current<1?1:w.level.current,2*t+5}var w,V=[],k=r(c.sKey+""+c.sKey),I=r(c.sKey+""+c.sKey+c.sKey);this.getGameData=function(){return w},this.getGameHistory=function(){return V},this.getEmptyBlockMap=function(){return w.emptyBlockMap},this.newGame=function(){V=[],w=new GameData,w.emptyBlockMap=[];var o=w.gameMap;for(o=new Array(c.bS),r=0;r<c.bS;r++)for(o[r]=new Array(c.bS),j=0;j<c.bS;j++)o[r][j]=0;for(var r=0;4>r;r++)w.turnValue[r]=M(1,11);for(w.gameMap=o,r=0;r<c.bS;r++)for(j=0;j<c.bS;j++)y(r,j);t(c.initCount),w.level.toGo=10},this.popOutTurn=function(){var r=0,e=w.level.current;5>e&&(r=1),e>=5&&10>e&&(r=2),e>=10&&15>e&&(r=3),e>=15&&(r=4),t(r),o()},this.isHasContinue=function(){return void 0!=localStorage.getItem(k)?!0:!1},this.continueGame=function(){var t=localStorage.getItem(k),o=localStorage.getItem(I);void 0!=t&&void 0!=o?(w=JSON.parse(r(t)),v()?V=JSON.parse(r(o)):this.newGame()):this.newGame()},this.turn=function(t,r){var e={error:[],state:"",score:0,isGameOver:!1},n=w.gameMap;if(t=parseInt(t),r=parseInt(r),!C(t,r))return e.error.push(1),e;if(0!=n[t][r])return e.error.push(1),e;V.length>50&&V.pop(),V.unshift(JSON.stringify(w)),multipolar=w.bonus.multipolar.isActive,bomb=w.bonus.bomb.isActive,n[t][r]=w.turnValue[0],y(t,r);var u=!1;bomb?(e.state=p(n,"bomb",t,r),u=w.bonus.bomb.isActive,w.bonus.bomb.count--,w.bonus.bomb.isActive=!1):multipolar?(e.state=p(n,"mul",t,r),u=w.bonus.multipolar.isActive,w.bonus.multipolar.count--,w.bonus.multipolar.isActive=!1):e.state=p(n,"nor",t,r);var i=g(e.state,w.comboCount);e.score=i.scoreTotal,w.score=w.score+e.score,i.scoreCount>=c.bombMin&&!u&&w.bonus.bomb.count++;var a=w.comboCount;h(e.state)?(w.comboCount=a+1,w.comboCount%c.mulMin==0&&w.bonus.multipolar.count++):0!=w.comboCount&&(w.combo.push(w.comboCount),w.comboCount=0),b();w.level.current;return w.turnValue.shift(),w.turnValue.push(M(A(),G())),o(),e.isGameOver=this.isGameOver(),e},this.isBoxEmpty=function(t,o){return 0!=w.gameMap[t][o]?!1:!0},this.turnPreview=function(t,o){var r=w.bonus.multipolar.isActive,e=w.bonus.bomb.isActive;return e?p(gameMap,"bomb",t,o,!0):r?p(gameMap,"mul",t,o,!0):p(gameMap,"nor",t,o,!0)},this.undo=function(){if(this.isCanUndo()){var t=w.bonus.undo.count;w=JSON.parse(V.shift()),t--,w.bonus.undo.count=t}},this.isCanUndo=function(){return void 0==V?!1:V.length>0&&w.bonus.undo.count>0?!0:!1},this.bonus=function(t){var o=w.bonus;if("multipolar"!=t&&"bomb"!=t)return!1;var r=o[t].isActive,e=o[t].count;return r=1>e?!1:r?!1:!0,o[t].isActive=r,r&&("multipolar"==t?o.bomb.isActive=!1:"","bomb"==t?o.multipolar.isActive=!1:""),r},this.isGameOver=function(){return 0!=w.emptyBlockMap.length?!1:(w.bonus.undo.count=0,e(),!0)}}var c={bS:7,bombMin:5,mulMin:6,sKey:"nananabatman",match:5859,popCount:1,undoStart:2,initCount:5};
