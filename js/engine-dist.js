function GameData(){this.score=0,this.level={current:0,toGo:0,totalThisLevel:0},this.comboCount=0,this.combo=[],this.bonus={multipolar:{count:1,isActive:!1},undo:{count:c.undoStart},bomb:{count:1,isActive:!1}},this.emptyBlockMap=[],this.gameMap=[],this.turn={turnCount:0,turnCurrentLevel:0},this.turnValue=[0,0,0,0],this.scores=0}function Game(){function t(t){var o=0,e=0,r=w.level.current;r=0==r?r+1:r;for(var n=w.gameMap;o!=t;){var u=w.emptyBlockMap[M(0,w.emptyBlockMap.length-1)];if(void 0==u)break;var i=parseInt(u.split(".")[0]),a=parseInt(u.split(".")[1]);if(n[i][a]=M(A(),G()),y(i,a),o++,e++,e>1e3)break}}function o(){l(),localStorage.setItem(k,e(JSON.stringify(w))),localStorage.setItem(I,e(JSON.stringify(V)))}function e(t){var o="",e=c.match;for(i=0;i<t.length;i++)o+=String.fromCharCode(e^t.charCodeAt(i));return o}function r(){localStorage.removeItem(I),localStorage.removeItem(k),delete localStorage[k],delete localStorage[I],V=[]}function n(t,o,e){return t*o*e+(t-e*o)}function u(t,o,e){return t+o+e}function a(t,o,e){return t*o+e}function s(t,o,e){return a(o,t,t)+n(e,o,o)}function l(){var t=w.score,o=w.level.current,e=w.comboCount,r=w.bonus.multipolar.count,i=w.level.toGo,c=w.turn.turnCount;w.scores=n(t,o,e)+u(o,e,i)+a(e,r,i)-s(r,i,c)}function v(){var t=w.score,o=w.level.current,e=w.comboCount,r=w.bonus.multipolar.count,i=w.level.toGo,c=w.turn.turnCount;return w.scores==n(t,o,e)+u(o,e,i)+a(e,r,i)-s(r,i,c)?!0:!1}function m(t){return 5*t+5}function b(){var t=w.level.current,o=w.level.toGo,e=m(t),r=w.turn.turnCount,n=w.turn.turnCurrentLevel,u=w.level.totalThisLevel;0==t&&(t=1,o=m(t),r=0,n=1,u=10),remain=e-o,remain==e-1?(t+=1,o=m(t),w.bonus.undo.count++,n=1,u=o):(o--,n++),r++,w.level.current=t,w.level.toGo=o,w.turn.turnCount=r,w.turn.turnCurrentLevel=n,w.level.totalThisLevel=u}function f(t){return t%2==0?!0:!1}function p(t,o,e,r,n){var u=new Array(c.bS);for(i=0;i<c.bS;i++)for(u[i]=new Array(c.bS),a=0;a<c.bS;a++)u[i][a]={score:void 0,newV:void 0,oldV:void 0};if("bomb"==o)for(var i=-1;2>i;i++)for(var a=-1;2>a;a++){var s,l,v=e+i,m=r+a;if(C(v,m)&&(s=t[e][r],l=t[v][m],d(l,i,a,o))){var b=0,f=l;u[v][m]={score:f,newV:b,oldV:l},n||(t[v][m]=b,y(v,m))}}else if("mul"==o)for(var i=-1;2>i;i++)for(var a=-1;2>a;a++){var s,l,v=e+i,m=r+a;if(C(v,m)&&(s=t[e][r],l=t[v][m],d(l,i,a,o))){var b=l-s;b=0>b?0:b;var f=l-b;u[v][m]={score:f,newV:b,oldV:l},n||(t[v][m]=b,y(v,m))}}else for(var i=-1;2>i;i++)for(var a=-1;2>a;a++){var s,l,v=e+i,m=r+a;if(C(v,m)&&(s=t[e][r],l=t[v][m],d(l,i,a,o))){var b=0,f=0;S(l,s)?(b=l-s,b=0>b?0:b,f=l-b):(b=l+s,f=0),u[v][m]={score:f,newV:b,oldV:l},n||(t[v][m]=b,y(v,m))}}return u}function h(t){for(var o=0;o<t.length;o++)for(var e=0;e<t[o].length;e++)if(0==t[o][e].newV)return!0}function g(t){for(var o=0,e=0,r=0;r<t.length;r++)for(var n=0;n<t[r].length;n++)void 0!=t[r][n].score&&(o+=t[r][n].score,0==t[r][n].newV&&(e+=1));return{scoreTotal:o*w.level.current,scoreCount:e}}function S(t,o){return f(t)==f(o)?!0:!1}function d(t,o,e,r){return 0==t||0==o&&0==e&&"bomb"!=r?!1:!0}function C(t,o){return t>c.bS-1||0>t||o>c.bS-1||0>o?!1:!0}function M(t,o){return Math.floor(Math.random()*(o-t))+t}function y(t,o){var e=w.emptyBlockMap,r=t+"."+o;if(0==w.gameMap[t][o])e.push(r);else for(var n=e.length-1;n>=0;n--)if(e[n]===r){e.splice(n,1);break}}function A(){var t;return t=w.level.current<1?1:w.level.current,2*t-1}function G(){var t;return t=w.level.current<1?1:w.level.current,2*t+5}var w,V=[],k=e(c.sKey+""+c.sKey),I=e(c.sKey+""+c.sKey+c.sKey);this.getGameData=function(){return w},this.getGameHistory=function(){return V},this.getEmptyBlockMap=function(){return w.emptyBlockMap},this.newGame=function(){V=[],w=new GameData,w.emptyBlockMap=[];var o=w.gameMap;for(o=new Array(c.bS),e=0;e<c.bS;e++)for(o[e]=new Array(c.bS),j=0;j<c.bS;j++)o[e][j]=0;for(var e=0;4>e;e++)w.turnValue[e]=M(1,11);for(w.gameMap=o,e=0;e<c.bS;e++)for(j=0;j<c.bS;j++)y(e,j);t(c.initCount),w.level.toGo=10},this.popOutTurn=function(){var e=0,r=w.level.current;5>r&&(e=1),r>=5&&10>r&&(e=2),r>=10&&15>r&&(e=3),r>=15&&(e=4),t(e),o()},this.isHasContinue=function(){return void 0!=localStorage.getItem(k)?!0:!1},this.continueGame=function(){var t=localStorage.getItem(k),o=localStorage.getItem(I);void 0!=t&&void 0!=o?(w=JSON.parse(e(t)),v()?V=JSON.parse(e(o)):this.newGame()):this.newGame()},this.turn=function(t,e){console.time("turn");var r={error:[],state:"",score:0,isGameOver:!1},n=w.gameMap;if(t=parseInt(t),e=parseInt(e),!C(t,e))return r.error.push(1),r;if(0!=n[t][e])return r.error.push(1),r;V.length>50&&V.pop(),V.unshift(JSON.stringify(w)),multipolar=w.bonus.multipolar.isActive,bomb=w.bonus.bomb.isActive,n[t][e]=w.turnValue[0],y(t,e);var u=!1;bomb?(r.state=p(n,"bomb",t,e),u=w.bonus.bomb.isActive,w.bonus.bomb.count--,w.bonus.bomb.isActive=!1):multipolar?(r.state=p(n,"mul",t,e),u=w.bonus.multipolar.isActive,w.bonus.multipolar.count--,w.bonus.multipolar.isActive=!1):r.state=p(n,"nor",t,e);var i=g(r.state,w.comboCount);r.score=i.scoreTotal,w.score=w.score+r.score,i.scoreCount>=c.bombMin&&!u&&w.bonus.bomb.count++;var a=w.comboCount;h(r.state)?(w.comboCount=a+1,w.comboCount%c.mulMin==0&&w.bonus.multipolar.count++):0!=w.comboCount&&(w.combo.push(w.comboCount),w.comboCount=0),b();w.level.current;return w.turnValue.shift(),w.turnValue.push(M(A(),G())),o(),r.isGameOver=this.isGameOver(),console.timeEnd("turn"),r},this.isBoxEmpty=function(t,o){return 0!=w.gameMap[t][o]?!1:!0},this.turnPreview=function(t,o){var e=w.bonus.multipolar.isActive,r=w.bonus.bomb.isActive;return r?p(gameMap,"bomb",t,o,!0):e?p(gameMap,"mul",t,o,!0):p(gameMap,"nor",t,o,!0)},this.undo=function(){if(this.isCanUndo()){var t=w.bonus.undo.count;w=JSON.parse(V.shift()),t--,w.bonus.undo.count=t}},this.isCanUndo=function(){return void 0==V?!1:V.length>0&&w.bonus.undo.count>0?!0:!1},this.bonus=function(t){var o=w.bonus;if("multipolar"!=t&&"bomb"!=t)return!1;var e=o[t].isActive,r=o[t].count;return e=1>r?!1:e?!1:!0,o[t].isActive=e,e&&("multipolar"==t?o.bomb.isActive=!1:"","bomb"==t?o.multipolar.isActive=!1:""),e},this.isGameOver=function(){return 0!=w.emptyBlockMap.length?!1:(w.bonus.undo.count=0,r(),!0)}}var c={bS:7,bombMin:5,mulMin:6,sKey:"nananabatman",match:5859,popCount:1,undoStart:2,initCount:5};
