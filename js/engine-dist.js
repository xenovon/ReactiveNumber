function GameData(){this.score=0,this.level={current:0,toGo:0,totalThisLevel:0},this.comboCount=0,this.combo=[],this.bonus={multipolar:{count:1,isActive:!1},undo:{count:c.undoStart},bomb:{count:1,isActive:!1}},this.emptyBlockMap=[],this.gameMap=[],this.turn={turnCount:0,turnCurrentLevel:0},this.turnValue=[0,0,0,0],this.scores=0}function Game(){function t(t){var o=0,e=0,n=k.level.current;n=0==n?n+1:n;for(var r=k.gameMap;o!=t;){var u=k.emptyBlockMap[y(0,k.emptyBlockMap.length-1)];if(void 0==u)break;var i=parseInt(u.split(".")[0]),a=parseInt(u.split(".")[1]);if(r[i][a]=y(A(),G()),M(i,a),o++,e++,e>1e3)break}}function o(){console.time("turn"),s(),localStorage.setItem(V,e(JSON.stringify(k))),localStorage.setItem(O,e(JSON.stringify(w))),console.log("saved"),console.timeEnd("turn")}function e(t){var o=100,e="",o=c.match;for(i=0;i<t.length;i++)e+=String.fromCharCode(o^t.charCodeAt(i));return e}function n(){localStorage.removeItem(O),localStorage.removeItem(V),delete localStorage[V],delete localStorage[O],console.log("deleted"),w=[]}function r(t,o,e){return t*o*e+(t-e*o)}function u(t,o,e){return t+o+e}function a(t,o,e){return t*o+e}function l(t,o,e){return a(o,t,t)+r(e,o,o)}function s(){var t=k.score,o=k.level.current,e=k.comboCount,n=k.bonus.multipolar.count,i=k.level.toGo,c=k.turn.turnCount;k.scores=r(t,o,e)+u(o,e,i)+a(e,n,i)-l(n,i,c)}function m(){var t=k.score,o=k.level.current,e=k.comboCount,n=k.bonus.multipolar.count,i=k.level.toGo,c=k.turn.turnCount;return k.scores==r(t,o,e)+u(o,e,i)+a(e,n,i)-l(n,i,c)?!0:!1}function v(t){return 5*t+5}function b(){var t=k.level.current,o=k.level.toGo,e=v(t),n=k.turn.turnCount,r=k.turn.turnCurrentLevel,u=k.level.totalThisLevel;0==t&&(t=1,o=v(t),n=0,r=1,u=10),remain=e-o,remain==e-1?(t+=1,o=v(t),k.bonus.undo.count++,r=1,u=o):(o--,r++),n++,k.level.current=t,k.level.toGo=o,k.turn.turnCount=n,k.turn.turnCurrentLevel=r,k.level.totalThisLevel=u}function f(t){return t%2==0?!0:!1}function p(t,o,e,n,r){var u=new Array(c.bS);for(i=0;i<c.bS;i++)for(u[i]=new Array(c.bS),a=0;a<c.bS;a++)u[i][a]={score:void 0,newV:void 0,oldV:void 0};if("bomb"==o)for(var i=-1;2>i;i++)for(var a=-1;2>a;a++){var l,s,m=e+i,v=n+a;if(C(m,v)&&(l=t[e][n],s=t[m][v],S(s,i,a,o))){var b=0,f=s;u[m][v]={score:f,newV:b,oldV:s},r||(t[m][v]=b,M(m,v))}}else if("mul"==o)for(var i=-1;2>i;i++)for(var a=-1;2>a;a++){var l,s,m=e+i,v=n+a;if(C(m,v)&&(l=t[e][n],s=t[m][v],S(s,i,a,o))){var b=s-l;b=0>b?0:b;var f=s-b;u[m][v]={score:f,newV:b,oldV:s},r||(t[m][v]=b,M(m,v))}}else for(var i=-1;2>i;i++)for(var a=-1;2>a;a++){var l,s,m=e+i,v=n+a;if(C(m,v)&&(l=t[e][n],s=t[m][v],S(s,i,a,o))){var b=0,f=0;d(s,l)?(b=s-l,b=0>b?0:b,f=s-b):(b=s+l,f=0),u[m][v]={score:f,newV:b,oldV:s},r||(t[m][v]=b,M(m,v))}}return u}function h(t){for(var o=0;o<t.length;o++)for(var e=0;e<t[o].length;e++)if(0==t[o][e].newV)return!0}function g(t){for(var o=0,e=0,n=0;n<t.length;n++)for(var r=0;r<t[n].length;r++)void 0!=t[n][r].score&&(o+=t[n][r].score,0==t[n][r].newV&&(e+=1));return{scoreTotal:o*k.level.current,scoreCount:e}}function d(t,o){return f(t)==f(o)?!0:!1}function S(t,o,e,n){return 0==t||0==o&&0==e&&"bomb"!=n?!1:!0}function C(t,o){return t>c.bS-1||0>t||o>c.bS-1||0>o?!1:!0}function y(t,o){return Math.floor(Math.random()*(o-t))+t}function M(t,o){var e=k.emptyBlockMap,n=t+"."+o;if(0==k.gameMap[t][o])e.push(n);else{for(var r=e.length-1;r>=0;r--)if(e[r]===n){e.splice(r,1);break}console.log(JSON.stringify(n))}console.log(JSON.stringify(e))}function A(){var t;return t=k.level.current<1?1:k.level.current,2*t-1}function G(){var t;return t=k.level.current<1?1:k.level.current,2*t+5}var k,w=[],V=e(c.sKey+""+c.sKey),O=e(c.sKey+""+c.sKey+c.sKey);this.getGameData=function(){return k},this.getGameHistory=function(){return w},this.getEmptyBlockMap=function(){return k.emptyBlockMap},this.newGame=function(){w=[],k=new GameData,k.emptyBlockMap=[];var o=k.gameMap;for(o=new Array(c.bS),e=0;e<c.bS;e++)for(o[e]=new Array(c.bS),j=0;j<c.bS;j++)o[e][j]=0;for(var e=0;4>e;e++)k.turnValue[e]=y(1,11);for(k.gameMap=o,e=0;e<c.bS;e++)for(j=0;j<c.bS;j++)M(e,j);t(c.initCount),k.level.toGo=10},this.popOutTurn=function(){var e=0,n=k.level.current;5>n&&(e=1),n>=5&&10>n&&(e=2),n>=10&&15>n&&(e=3),n>=15&&(e=4),console.log(e+" "+n),t(e),o()},this.isHasContinue=function(){return void 0!=localStorage.getItem(V)?!0:!1},this.continueGame=function(){var t=localStorage.getItem(V),o=localStorage.getItem(O);void 0!=t&&void 0!=o?(k=JSON.parse(e(t)),m()?w=JSON.parse(e(o)):this.newGame()):this.newGame()},this.turn=function(t,e){console.time("turn");var n={error:[],state:"",score:0,isGameOver:!1},r=k.gameMap;if(t=parseInt(t),e=parseInt(e),!C(t,e))return n.error.push(1),n;if(0!=r[t][e])return n.error.push(1),n;w.length>50&&w.pop(),w.unshift(JSON.stringify(k)),multipolar=k.bonus.multipolar.isActive,bomb=k.bonus.bomb.isActive,r[t][e]=k.turnValue[0],M(t,e);var u=!1;bomb?(n.state=p(r,"bomb",t,e),u=k.bonus.bomb.isActive,k.bonus.bomb.count--,k.bonus.bomb.isActive=!1):multipolar?(n.state=p(r,"mul",t,e),u=k.bonus.multipolar.isActive,k.bonus.multipolar.count--,k.bonus.multipolar.isActive=!1):n.state=p(r,"nor",t,e);var i=g(n.state,k.comboCount);n.score=i.scoreTotal,k.score=k.score+n.score,i.scoreCount>=c.bombMin&&!u&&k.bonus.bomb.count++;var a=k.comboCount;h(n.state)?(k.comboCount=a+1,k.comboCount==c.mulMin&&k.bonus.multipolar.count++):0!=k.comboCount&&(k.combo.push(k.comboCount),k.comboCount=0),b();k.level.current;return k.turnValue.shift(),k.turnValue.push(y(A(),G())),o(),n.isGameOver=this.isGameOver(),console.log("kotak kosong "+k.emptyBlockMap.length),console.timeEnd("turn"),n},this.isBoxEmpty=function(t,o){return 0!=k.gameMap[t][o]?!1:!0},this.turnPreview=function(t,o){var e=k.bonus.multipolar.isActive,n=k.bonus.bomb.isActive;return n?p(gameMap,"bomb",t,o,!0):e?p(gameMap,"mul",t,o,!0):p(gameMap,"nor",t,o,!0)},this.undo=function(){if(this.isCanUndo()){var t=k.bonus.undo.count;k=JSON.parse(w.shift()),t--,k.bonus.undo.count=t}},this.isCanUndo=function(){return void 0==w?!1:w.length>0&&k.bonus.undo.count>0?!0:!1},this.bonus=function(t){var o=k.bonus;if("multipolar"!=t&&"bomb"!=t)return!1;var e=o[t].isActive,n=o[t].count;return e=1>n?!1:e?!1:!0,o[t].isActive=e,e&&("multipolar"==t?o.bomb.isActive=!1:"","bomb"==t?o.multipolar.isActive=!1:""),e},this.isGameOver=function(){return 0!=k.emptyBlockMap.length?!1:(k.bonus.undo.count=0,n(),!0)}}var c={bS:7,bombMin:5,mulMin:6,sKey:"nananabatman",match:589,popCount:1,undoStart:2,initCount:5};
